version 5

. $REGRESSDIR/include/regression.conf

interface eth0 myeth0
	policy deny
	ipv4 client tftp accept src not "any.old.rubbish1"
	ipv4 client ssh accept src not "any.old.rubbish1"

audit_results_script() {
  local tmpdir="${1}"
  local status="${2}"
  local logfile="${3}"
  shift; shift; shift;

  local expected_status=1
  if [ $status -ne $expected_status ]
  then
    echo "Unexpected status $status (expected $expected_status)"
    return 1
  fi

  tail -n 1 "${logfile}" > $tmpdir/$$.log || return 1
  if grep -q "^Activating new firewall ([0-9]* rules): OK$" $tmpdir/$$.log
  then
    echo "Log did not end as expected: firewall got avtivated"
    return 1
  fi

  if ! grep -q "host.network.*not found" "${logfile}"
  then
    echo "Reason for failure we expected was not mentioned"
    return 1
  fi
  return 0
}
