#
# Test demonstrating inability to use DNS names when activation policy set
# to drop.
#
version 5

. $REGRESSDIR/include/regression.conf

FIREHOL_INPUT_ACTIVATION_POLICY="DROP"
FIREHOL_OUTPUT_ACTIVATION_POLICY="DROP"
FIREHOL_FORWARD_ACTIVATION_POLICY="DROP"
FIREHOL_ESTABLISHED_ACTIVATION_ACCEPT="1"

if [ "$FIREHOL_OUTPUT_ACTIVATION_POLICY" = "ACCEPT" ]; then
# This interface is set up to allow DNS lookups in e.g. fast activation
# mode, when IPv4 rules will all come into place with their final policy
# before IPv6 is processed
interface any myany
	policy deny
	client dns accept
fi

interface eth0 myeth0
	policy deny
	client http accept dst test-both.firehol.org

interface eth1 myeth1
	policy deny

router e0toe1 inface eth0 outface eth1
	policy deny

router e1toe0 inface eth1 outface eth0
	policy deny

check_results_script() {
  local tmpdir="${1}"
  local status="${2}"
  local logfile="${3}"
  local v4output="${4}"
  local v6output="${5}"
  shift; shift; shift; shift; shift;

  local expected_status=1
  if [ $status -ne $expected_status ]
  then
    echo "Unexpected status $status (expected $expected_status)"
    return 1
  fi

  tail -n 1 "${logfile}" > $tmpdir/$$.log || return 1
  if grep -q "[aA]ctivating new firewall[^:]*: OK$" $tmpdir/$$.log
  then
    echo "Log did not end as expected: firewall got activated"
    return 1
  fi

  if ! grep -q "host.network.*not found" "${logfile}"
  then
    echo "Reason for failure we expected was not mentioned"
    return 1
  fi
  return 0
}
