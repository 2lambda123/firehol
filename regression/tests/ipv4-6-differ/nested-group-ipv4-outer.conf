. ${REGRESSDIR}include/regression.conf

interface eth0 myeth0
	policy deny
	group4 with tos 11
		group with mark 22
			server ssh accept
		group end
		server telnet accept
	group end


audit_results_ipv4() {
#
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT DROP [0:0]
:in_group1 - [0:0]
:in_group1_telnet_s2 - [0:0]
:in_group2 - [0:0]
:in_group2_ssh_s1 - [0:0]
:in_myeth0 - [0:0]
:out_group1 - [0:0]
:out_group1_telnet_s2 - [0:0]
:out_group2 - [0:0]
:out_group2_ssh_s1 - [0:0]
:out_myeth0 - [0:0]
-A INPUT -i lo -j ACCEPT
-A INPUT -i eth0 -j in_myeth0
-A INPUT -m conntrack --ctstate RELATED -j ACCEPT
-A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,ACK -j DROP
-A INPUT -m limit --limit 1/sec -j LOG --log-prefix "IN-unknown:"
-A INPUT -j DROP
-A FORWARD -m conntrack --ctstate RELATED -j ACCEPT
-A FORWARD -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,ACK -j DROP
-A FORWARD -m limit --limit 1/sec -j LOG --log-prefix "PASS-unknown:"
-A FORWARD -j DROP
-A OUTPUT -o lo -j ACCEPT
-A OUTPUT -o eth0 -j out_myeth0
-A OUTPUT -m conntrack --ctstate RELATED -j ACCEPT
-A OUTPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,ACK -j DROP
-A OUTPUT -m limit --limit 1/sec -j LOG --log-prefix "OUT-unknown:"
-A OUTPUT -j DROP
-A in_group1 -m mark --mark 0x580/0x1fc0 -j in_group2
-A in_group1 -j in_group1_telnet_s2
-A in_group1_telnet_s2 -p tcp -m tcp --sport 1024:65535 --dport 23 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
-A in_group2 -j in_group2_ssh_s1
-A in_group2_ssh_s1 -p tcp -m tcp --sport 1024:65535 --dport 22 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
-A in_myeth0 -m tos --tos 0x0b/0xff -j in_group1
-A in_myeth0 -m conntrack --ctstate RELATED -j ACCEPT
-A in_myeth0 -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,ACK -j DROP
-A in_myeth0 -m limit --limit 1/sec -j LOG --log-prefix "IN-myeth0:"
-A in_myeth0 -j DROP
-A out_group1 -m mark --mark 0x580/0x1fc0 -j out_group2
-A out_group1 -j out_group1_telnet_s2
-A out_group1_telnet_s2 -p tcp -m tcp --sport 23 --dport 1024:65535 -m conntrack --ctstate ESTABLISHED -j ACCEPT
-A out_group2 -j out_group2_ssh_s1
-A out_group2_ssh_s1 -p tcp -m tcp --sport 22 --dport 1024:65535 -m conntrack --ctstate ESTABLISHED -j ACCEPT
-A out_myeth0 -m tos --tos 0x0b/0xff -j out_group1
-A out_myeth0 -m conntrack --ctstate RELATED -j ACCEPT
-A out_myeth0 -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,ACK -j DROP
-A out_myeth0 -m limit --limit 1/sec -j LOG --log-prefix "OUT-myeth0:"
-A out_myeth0 -j DROP
COMMIT
#
#
*mangle
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A PREROUTING -m conntrack --ctstate RELATED,ESTABLISHED -j CONNMARK --restore-mark --nfmask 0xffffffff --ctmask 0xffffffff
-A INPUT -m conntrack --ctstate NEW -j CONNMARK --save-mark --nfmask 0xffffffff --ctmask 0xffffffff
-A OUTPUT -m conntrack --ctstate RELATED,ESTABLISHED -j CONNMARK --restore-mark --nfmask 0xffffffff --ctmask 0xffffffff
-A POSTROUTING -m conntrack --ctstate NEW -j CONNMARK --save-mark --nfmask 0xffffffff --ctmask 0xffffffff
COMMIT
#
#
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
COMMIT
#
}

audit_results_ipv6() {
#
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT DROP [0:0]
:in_myeth0 - [0:0]
:out_myeth0 - [0:0]
-A INPUT -i lo -j ACCEPT
-A INPUT -i eth0 -j in_myeth0
-A INPUT -m conntrack --ctstate RELATED -j ACCEPT
-A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,ACK -j DROP
-A INPUT -m limit --limit 1/sec -j LOG --log-prefix "IN-unknown:"
-A INPUT -j DROP
-A FORWARD -m conntrack --ctstate RELATED -j ACCEPT
-A FORWARD -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,ACK -j DROP
-A FORWARD -m limit --limit 1/sec -j LOG --log-prefix "PASS-unknown:"
-A FORWARD -j DROP
-A OUTPUT -o lo -j ACCEPT
-A OUTPUT -o eth0 -j out_myeth0
-A OUTPUT -m conntrack --ctstate RELATED -j ACCEPT
-A OUTPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,ACK -j DROP
-A OUTPUT -m limit --limit 1/sec -j LOG --log-prefix "OUT-unknown:"
-A OUTPUT -j DROP
-A in_myeth0 -m conntrack --ctstate RELATED -j ACCEPT
-A in_myeth0 -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,ACK -j DROP
-A in_myeth0 -m limit --limit 1/sec -j LOG --log-prefix "IN-myeth0:"
-A in_myeth0 -j DROP
-A out_myeth0 -m conntrack --ctstate RELATED -j ACCEPT
-A out_myeth0 -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,ACK -j DROP
-A out_myeth0 -m limit --limit 1/sec -j LOG --log-prefix "OUT-myeth0:"
-A out_myeth0 -j DROP
COMMIT
#
#
*mangle
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A PREROUTING -m conntrack --ctstate RELATED,ESTABLISHED -j CONNMARK --restore-mark --nfmask 0xffffffff --ctmask 0xffffffff
-A INPUT -m conntrack --ctstate NEW -j CONNMARK --save-mark --nfmask 0xffffffff --ctmask 0xffffffff
-A OUTPUT -m conntrack --ctstate RELATED,ESTABLISHED -j CONNMARK --restore-mark --nfmask 0xffffffff --ctmask 0xffffffff
-A POSTROUTING -m conntrack --ctstate NEW -j CONNMARK --save-mark --nfmask 0xffffffff --ctmask 0xffffffff
COMMIT
#
#
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
COMMIT
#
}
